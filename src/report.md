# Part 1. Инструкция ipcalc

## 1.1 Сети и маски 

* Адрес сети 192.167.38.54/13

+ 192.167.38.54

* Перевод маски 255.255.255.0 в перфиксную и двоичную запись

+ Префиксная запись: /24
+ Двоичная запись: 11111111.11111111.11111111.00000000

* Перевод маски /15 в обычную и двоичную запись:

+ Обычная запись: 255.254.0.0
+ Двоичная запись: 11111111.11111110.00000000.00000000

* Перевод маски 11111111.11111111.11111111.11110000 в обычную и префиксную запись

+ Обычная запись: 255.255.255.240
+ Префиксная запись: /28

* Минимальный и максимальный хост в сети 12.167.38.4

+ При маске /8: 12.0.0.1 и 12.255.255.254
+ При маске 11111111.11111111.00000000.00000000: 12.167.0.1 и 12.167.255.254
+ При маске 255.255.254.0: 12.167.38.1 и 12.167.39.254
+ При маске /4: 0.0.0.1 и 15.255.255.254

## 1.2 localhost

* Определи и запиши в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP

+ 194.34.23.100: Нет
+ 127.0.0.2: Да
+ 127.1.0.1: Да
+ 128.0.0.1: Нет

## 1.3 Диапазоны и сегменты сетей

* Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1

+ Публичные: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1
+ Частные: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10

* Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255

+ Возможные IP: 10.10.0.2, 10.10.10.10, 10.10.1.255

# Part 2. Статическая маршрутизация между двумя машинами

* * Поднимаем вторую ВМ
* С помощью команды `ip a` смотрим существующие сетевые интерфейсы:
![ip a](Part2.1.png)
* Опишем сетевой интерфейс, соответствующий внутренней сети, на обеих машинах:
![netplan](Part2.2.png)
* Выполним команду `netplan apply` для перезапуска сервиса сети
![netplan apply](Part2.3.png)

## Добавление статического маршрута вручную

* Добавили статический маршрут от одной машины до другой и обратно при помощи команд `sudo ip route add 192.168.100.10 via 172.24.116.8` и `sudo ip route add 172.24.116.8 via 192.168.100.10`.

* Пропингуем соединение между машинами.
![ping](Part2.4.png)

## Добавление статического маршрута с сохранением

* Перезапустим машины при помощи `sudo reboot`.
* Добавим статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml
![stat](Part2.5.png)
* Пропингуем соединение между машинами.
![ping_1](Part2.6.png)

# Part 3. Утилита iperf3

## Скорость соединения

* 8 Mbps = 1 MB/s
* 100 MB/s = 819200 Kbps
* 1 Gbps = 1024 Mbps

## Утилита iperf3

* Передано 4.18 Mbytes со скоростью 3.44 Mbits/sec
![iperf](Part3.1.png)

# Part 4. Сетевой экран

## Утилита iptables

* Создаем файл `sudo vim /etc/firewall.sh`
* Добавляем правила
![rools](Part4.1.png)
* Запуск файлов на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`\
![start](Part4.2.png)
> Правила в iptables имеют приоритезацию, т.е. выполняются все попорядку сверху вниз. Таким образом, пакеты icmp на ws1 сначало попадут в правило DROP, а потом в ACCEPT и соответственно входящий трафик по протаколу icmp пойдет дальше. А вот на ws2 все наооброт.

## Утилита nmap

![nmap](Part4.3.png)

# Part 5. Статическая маршрутизация сети

## Настройка адресов машин

* Настрока конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
 ![network](Part5.1.png)

* Перезапустил сервис сети. Командой `ip -4 a` проверил, что адрес машины задан верно, также пропинговал ws3(ws22) с ws2(ws21) и аналогично пропинговал r1 с ws1(ws11).
![network_check](Part5.2.png)
![network_check](Part5.3.png)

## Включение переадресации IP-адресов

* Для включения переадресации IP, выполнил команду на роутерах: `sysctl -w net.ipv4.ip_forward=1`
![network_forward](Part5.4.png)
* Открыл файл /etc/sysctl.conf и добавил в него следующую строку: net.ipv4.ip_forward = 1
![network_forward_1](Part5.5.png)

## Установка маршрута по-умолчанию

* Настроил маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавил `default` перед IP роутера в файле конфигураций.
![network_conf](Part5.6.png)
* Вызвал `ip r`, чтобы добавился маршрут в таблицу маршрутизации.
![network_routers](Part5.7.png)
* Пропингуем с ws11 роутер r2 и покажи на r2, что пинг доходит. Для этого используем команду: `tcpdump -tn -i eth0`
![network_dump](Part5.8.png)

## Добавление статических маршрутов

* Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций
![network_conf](Part5.9.png)
* Вызовем `ip r` и покажем таблицы с маршрутами на обоих роутерах
![network_conf](Part5.10.png)
* Запустим команды на ws11:
`ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`
![network_conf](Part5.11.png)
* Если выбран маршрут, отличный от 0.0.0.0/0 для адреса 10.10.0.0/маска сети, значит в таблице маршрутизации имеется запись с более точным маршрутом, который указывает конкретный путь для доставки пакета на узел сети назначения.

## Построение списка маршрутизаторов

* Запустил на r1 команду дампа 
`sudo tcpdump -tnv -i enp0s8`
* При помощи утилиты traceroute построим список маршрутизаторов на пути от ws11 до ws21.
![network_dump](Part5.12.png)
*  Traceroute использует метод, при котором при отправке пакета устанавливается значение TTL в хедере IP пакета. При прохождении каждого маршрутизатора это значение уменьшается на единицу. Когда значение TTL достигает нуля, маршрутизатор отправляет ICMP пакет с сообщением "Time Exceeded" и своим IP-адресом обратно. Traceroute повторяет этот процесс, увеличивая значение TTL и записывая IP-адреса всех пройденных маршрутизаторов, пока пакет не достигнет своего назначения. Эта последовательность IP-адресов представляет маршрут следования пакета, который traceroute отображает в виде таблицы.

## Использование протокола ICMP при маршрутизации

* Запустим на r1 перехват сетевого трафика, проходящего через enp0s8 с помощью команды:
`tcpdump -n -i enp0s8 icmp`
* Пропингуем с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:S
`ping -c 1 10.30.0.111`
![ping](Part5.13.png)

# Part 6. Динамическая настройка IP с помощью DHCP

* Для r2 настроем в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
* Укажи адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
![dhcp_conf](Part6.1.png)
* В файле resolv.conf пропишем `nameserver 8.8.8.8`
![dhcp_resolv](Part6.2.png)
* Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server:\
![dhcp_restart](Part6.3.png)
* Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес:
![dhcp_check](Part6.4.png)
* Также пропингуем ws22 с ws21
![dhcp_ping](Part6.5.png)
* Укажем MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`.
![dhcp_mac](Part6.6.png)
* Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.
![dhcp_mac](Part6.7.png)
![dhcp_mac](Part6.8.png)
![dhcp_mac](Part6.9.png)
![dhcp_mac](Part6.10.png)
![dhcp_mac](Part6.11.png)

# Part 7. NAT

* В файле /etc/apache2/ports.conf на ws22 и r1 измени строку Listen 80 на Listen 0.0.0.0:80, то есть сделай сервер Apache2 общедоступным.
![apache](Part7.1.png)
* Запусти веб-сервер Apache командой `service apache2 start` на ws22 и r1.
![apache](Part7.2.png)
* Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) Удаление правил в таблице filter - `iptables -F`;
2) Удаление правил в таблице "NAT" - `iptables -F -t nat`;
3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`.
* Запусти файл также, как в Части 4.
* Проверь соединение между ws22 и r1 командой `ping`.
![apache](Part7.3.png)
![apache](Part7.4.png)
* Добавь в файл ещё одно правило:
4) Разрешить маршрутизацию всех пакетов протокола ICMP.
* Запусти файл также, как в Части 4.
* Проверь соединение между ws22 и r1 командой `ping`
![apache](Part7.5.png)
![apache](Part7.6.png)
* Добавить в файл ещё два правила:
5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
![apache](Part7.7.png)
* Запусти файл также, как в Части 4.
* Проверь соединение по TCP для SNAT: для этого с ws22 подключиться к серверу Apache на r1 командой: `telnet 10.100.11 80`
![apache](Part7.8.png)
* Проверь соединение по TCP для DNAT: для этого с r1 подключиться к серверу Apache на ws22 командой: `telnet 10.100.0.12 8080`
![apache](Part7.9.png)